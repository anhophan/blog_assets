<!DOCTYPE html>
<html>
    <head>
        <base href="/" />
        <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
        <link rel="shortcut icon" type="image/x-icon" href="/ui/assets/img/favicon.ico" />
        <!-- Do not remove, Carbon style is used as base -->
        <link rel="stylesheet" href="/profile/static/carbon-components.min.css">
        <!---->
        <!-- Optionally override carbon styles using the common theme.css (common/page_components/default/page_style.css in Theme files) -->
        <link rel="stylesheet” href=“/template/v1.0/static/theme.css?themeId=@THEME_ID@" />
        <!---->
        <title>Solicited Passkey Registration</title>
        <script type="text/javascript">
            const LS_AMBIENT_CREDENTIALS = "ambientCredentials";


            var username = "@context.myusername@";
            var ac = null;
            var globalUVPARegistrationContext = null;

            /*
            * Prescriptive uses of WebAuthn options for different scenario profiles.
            * The primary object keys are used by callers for values of waprofile in
            * various functions below.
            */
            var webAuthnProfiles = {
                // user-verifying platform authenticator used for alternative-to-pwd reauthentication
                "uvpa": {
                    "attestationOptions": {
                        username: username,
                        displayName: username,
                        authenticatorSelection: {
                            userVerification: "required",
                            authenticatorAttachment: "platform"
                        },
                        attestation: "direct"
                    }
                }
            };


            function getBaseURL() {
                var locationHostPort = location.hostname+(location.port ? ':'+location.port: ''); 
                var baseURL = location.protocol+'//'+locationHostPort;

                return baseURL;
            }

            function htmlEncode(s) {
                if (s) {
                    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                } else {
                    return '';
                }
            }

            function htmlDecode(s) {
                if (s) {
                    return s.replace(/&quot;/g, '"').replace(/&gt;/g, '>').replace(/&lt;/g, '<').replace(/&amp;/g, '&');
                    
                } else {
                    return '';
                }
            }

            function hideDiv(id) {
                var mydiv = document.getElementById(id);
                if (mydiv != null) {
                    mydiv.style.display = "none";	
                }
                
            }

            function showDiv(id) {
                var mydiv = document.getElementById(id);
                if (mydiv != null) {
                    mydiv.style.display = "block";	
                }
            }

            function displayMessage(msg) {
                console.log("Msg: " + msg);
                document.getElementById("msgdiv").textContent = msg;
                showDiv("msgdiv");
            }

            function addHidden(theForm, key, value) {
                // Create a hidden input element, and append it to a form
                let input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                theForm.appendChild(input);
            }

            function getAmbientCredentials() {
                let acStr = localStorage.getItem(LS_AMBIENT_CREDENTIALS);
                return (acStr == null ? { users: {} } : JSON.parse(acStr));
            }

            function storeAmbientCredentials() {
                localStorage.setItem(LS_AMBIENT_CREDENTIALS, JSON.stringify(ac));
            }

            function registerUVPA() {
                document.getElementById("passkeyOperation").value = "register";
                document.getElementById("passkeyForm").submit();
            }

            function notNowUVPAA() {
                document.getElementById("passkeyOperation").value = "skip";
                document.getElementById("passkeyForm").submit();
            }

            function noUVPAA() {
                // update localStorage to indicate we never want to do this on this device
                if (!ac.users[username]) {
                    ac.users[username] = {};
                }
                ac.users[username].useFIDO = false;
                storeAmbientCredentials();

                document.getElementById("passkeyOperation").value = "skip";
                document.getElementById("passkeyForm").submit();
            }

            function promptUVPARegistration() {
                document.getElementById("msgdiv").innerHTML = 
                    "<h1>Sign in faster</h1><div>Hi <b>"+htmlEncode(username)+"</b>, </div>" +
                    "<p>Want to sign in faster? Add device authentication when signing in to use your device's biometric unlock instead.</p>" +
                    "<p>Note: Any users that are able to unlock this device with biometric unlock will also be able to access your account.</p>" +
                        "<input type=\"button\" value=\"Yes\" onclick=\"registerUVPA()\"/>" + "&nbsp;" +
                        "<input type=\"button\" value=\"Not now\" onclick=\"notNowUVPAA()\"/>" + "&nbsp;" +
                        "<input type=\"button\" value=\"Never on this device\" onclick=\"noUVPAA()\"/>" +
                    "</div></div></div></div>"; 
						showDiv("msgdiv");
            }


            function onLoad() {
                ac = getAmbientCredentials();

                promptUVPARegistration();
                showDiv("msgdiv");
            }
        </script>
    </head>
    <body class="cs-content" onload="onLoad()">
        <div class="content">
            <div>
                @PAGE_HEADER@
                <!-- You can add UI form here . The form action url should  MANDATORILY include the   @WORKFLOW_CALLBACK_URL@ macro  which will be a  callback url used to resume the workflow . If this macro is not included then the workflow will be BROKEN. -->
                <div id="msgdiv" style="display:none">
                </div>
                <form id="passkeyForm" method="POST" action="@WORKFLOW_CALLBACK_URL@">
                    <input type="hidden" id="passkeyOperation" name="passkeyOperation" value="register" />
                </form>    
        </div>
            <!---->
            @PAGE_FOOTER@
        </div>
        <script type="text/javascript" src="/profile/static/carbon-components.min.js"></script>
        <script type="text/javascript" src="/usc/js/ieCheck.js"></script>
        <!---->
    </body>
</html>  